# Design Intent: CapsWriter-Offline GUI 配置工具

## 1. 整体布局

### 1.1 主窗口结构

```
┌─────────────────────────────────────────────────────────────┐
│  [窗口标题: CapsWriter-Offline 配置工具]        [☀️ / 🌙]   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─ 🎙️ ASR 模型设置 ──────────────────────────────────────┐ │
│  │                                                         │ │
│  │   (●) Fun-ASR-Nano  - 速度与精度平衡，推荐              │ │
│  │   ( ) SenseVoice    - 极速，适合实时对话                │ │
│  │   ( ) Paraformer    - 高精度，适合离线转写              │ │
│  │                                                         │ │
│  │   [✓] 启用 Vulkan 加速    [ ] 强制 FP32 计算            │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌─ ⌨️ 快捷键设置 ─────────────────────────────────────────┐ │
│  │  ┌────────┬────────┬────────┬──────────┬────────┐       │ │
│  │  │  按键  │  类型  │  模式  │   角色   │  启用  │       │ │
│  │  ├────────┼────────┼────────┼──────────┼────────┤       │ │
│  │  │CapsLock│  键盘  │  长按  │   无     │   ✓    │       │ │
│  │  │   F1   │  键盘  │  长按  │   翻译   │   ✓    │       │ │
│  │  │   X2   │  鼠标  │  长按  │   无     │   ✓    │       │ │
│  │  └────────┴────────┴────────┴──────────┴────────┘       │ │
│  │                                                         │ │
│  │   [+ 添加快捷键]    [- 删除选中]                        │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌─ 🤖 LLM 设置 ───────────────────────────────────────────┐ │
│  │                                                         │ │
│  │   (●) 本地 Ollama        ( ) 云端 API                   │ │
│  │                                                         │ │
│  │   ┌─ 本地设置 ─────────────────────────────────────┐    │ │
│  │   │  模型: [gemma3:4b           ▼]                 │    │ │
│  │   └────────────────────────────────────────────────┘    │ │
│  │                                                         │ │
│  │   ┌─ 云端设置（禁用状态）─────────────────────────┐    │ │
│  │   │  Provider: [DeepSeek        ▼]                 │    │ │
│  │   │  API Key:  [****************    ]              │    │ │
│  │   │  Model:    [deepseek-chat       ]              │    │ │
│  │   └────────────────────────────────────────────────┘    │ │
│  │                                                         │ │
│  │   中断输出键: [ESC ▼]                                   │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌─ 📊 状态悬浮窗 ─────────────────────────────────────────┐ │
│  │                                                         │ │
│  │   [✓] 启用状态显示                                      │ │
│  │                                                         │ │
│  │   位置: [屏幕中央 ▼]                                    │ │
│  │                                                         │ │
│  │   透明度: ━━━━━━━━━━━━●━━━━━  85%                        │ │
│  │                                                         │ │
│  │   自动隐藏: [1.5] 秒                                    │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│         [💾 保存配置]              [🚀 启动服务]             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**注意**: 右上角 `[☀️ / 🌙]` 为主题切换按钮，浅色主题显示太阳图标，深色主题显示月亮图标。

---

## 1.2 主题切换组件

### 组件规格

| 元素 | 类型 | ID | 说明 |
|------|------|-----|------|
| 主题按钮 | Button | `btn_theme_toggle` | 图标切换，无边框 |

### 视觉规格

| 属性 | 浅色模式 | 深色模式 |
|------|----------|----------|
| 图标 | ☀️ (或 sun icon) | 🌙 (或 moon icon) |
| 大小 | 24×24 px | 24×24 px |
| 位置 | 标题栏右侧，距右边距 16px | 同左 |
| 背景 | 透明 | 透明 |
| 悬浮 | 浅灰圆形背景 | 深灰圆形背景 |

### 交互规则

```
1. 用户点击主题切换按钮
2. 切换 ttkbootstrap 主题
   ├─ 当前浅色: 切换到 "darkly"
   └─ 当前深色: 切换到 "litera"
3. 更新按钮图标
4. 实时刷新所有组件样式
5. 保存主题偏好到 config.json
```

### 动画效果

- **点击反馈**: 按钮缩小 0.9x，100ms 恢复
- **图标切换**: 淡入淡出动画 150ms（如支持）

---

## 2. 组件规格

### 2.1 ASR 模型面板

| 元素 | 类型 | ID | 说明 |
|------|------|-----|------|
| 分组框 | LabelFrame | `asr_frame` | 标题带 🎙️ |
| Fun-ASR-Nano | Radiobutton | `asr_funasr` | value='fun_asr_nano' |
| SenseVoice | Radiobutton | `asr_sensevoice` | value='sensevoice' |
| Paraformer | Radiobutton | `asr_paraformer` | value='paraformer' |
| Vulkan 加速 | Checkbutton | `gpu_vulkan` | 默认选中 |
| 强制 FP32 | Checkbutton | `gpu_fp32` | 默认未选中 |

**交互规则**:
- 模型选择互斥（单选）
- Vulkan 未选中时，FP32 选项禁用

---

### 2.2 快捷键面板

| 元素 | 类型 | ID | 说明 |
|------|------|-----|------|
| 分组框 | LabelFrame | `shortcut_frame` | 标题带 ⌨️ |
| 快捷键表格 | Treeview | `shortcut_table` | 5 列，可多选 |
| 添加按钮 | Button | `btn_add_shortcut` | 样式: 次要 |
| 删除按钮 | Button | `btn_del_shortcut` | 样式: 危险 |

**表格列定义**:

| 列名 | ID | 宽度 | 可编辑 |
|------|-----|------|--------|
| 按键 | `key` | 100px | 是 (点击捕获) |
| 类型 | `type` | 80px | 是 (下拉) |
| 模式 | `mode` | 80px | 是 (下拉) |
| 角色 | `role` | 100px | 是 (下拉) |
| 启用 | `enabled` | 60px | 是 (复选框) |

**交互规则**:
- 双击"按键"列触发按键捕获模式
- "角色"列下拉菜单从 `LLM/` 目录动态加载
- 删除需确认（如果是最后一个快捷键）

---

### 2.3 LLM 设置面板

| 元素 | 类型 | ID | 说明 |
|------|------|-----|------|
| 分组框 | LabelFrame | `llm_frame` | 标题带 🤖 |
| 本地 Ollama | Radiobutton | `llm_local` | value='ollama' |
| 云端 API | Radiobutton | `llm_cloud` | value='cloud' |
| 本地模型 | Combobox | `ollama_model` | 下拉 + 可输入 |
| Provider | Combobox | `cloud_provider` | 下拉固定选项 |
| API Key | Entry | `cloud_apikey` | show='*' |
| 云端模型 | Entry | `cloud_model` | 自由输入 |
| 中断键 | Combobox | `stop_key` | 下拉固定选项 |

**交互规则**:
- 切换"本地/云端"时，对应区域启用/禁用
- Ollama 模型列表初始加载 `ollama list`
- API Key 显示为掩码 `*`
- 可添加"显示/隐藏"按钮切换可见性

**Provider 选项**:
```
DeepSeek, OpenAI, Moonshot, 智谱, Gemini, Claude
```

**中断键选项**:
```
ESC, Space, Pause, F10, F11, F12
```

---

### 2.4 状态悬浮窗面板

| 元素 | 类型 | ID | 说明 |
|------|------|-----|------|
| 分组框 | LabelFrame | `overlay_frame` | 标题带 📊 |
| 启用开关 | Checkbutton | `overlay_enabled` | 默认选中 |
| 位置选择 | Combobox | `overlay_position` | 下拉固定选项 |
| 透明度滑块 | Scale | `overlay_opacity` | 范围 30-100 |
| 透明度标签 | Label | `opacity_label` | 动态显示百分比 |
| 延迟输入 | Entry | `overlay_delay` | 数字输入 |

**位置选项**:
```
屏幕中央, 左上角, 右上角, 左下角, 右下角
```

**交互规则**:
- 启用开关控制整个区域的启用/禁用状态
- 滑块拖动时实时更新标签
- 延迟输入验证: 0.5-5.0 秒

---

### 2.5 底部操作区

| 元素 | 类型 | ID | 说明 |
|------|------|-----|------|
| 保存配置 | Button | `btn_save` | 样式: 主要，带 💾 |
| 启动服务 | Button | `btn_launch` | 样式: 主要，带 🚀 |

**交互规则**:
- 保存成功后显示 toast 提示
- 启动服务前自动保存配置
- 启动服务按钮在服务运行时变为"停止服务"

---

## 3. 悬浮窗规格

### 3.1 布局

```
┌────────────────────────────────────┐
│  [图标]  [状态文字]      [时长]    │
└────────────────────────────────────┘
```

| 元素 | 规格 |
|------|------|
| 整体尺寸 | 220px × 56px |
| 圆角 | 12px |
| 内边距 | 12px 16px |
| 背景 | rgba(30, 30, 30, 0.85) |
| 阴影 | 0 4px 12px rgba(0,0,0,0.3) |

### 3.2 状态显示

| 状态 | 图标 | 文字 | 附加 |
|------|------|------|------|
| 录音中 | 🎙️ + 红点 | "正在录音..." | `{时长}s` |
| 识别中 | ⏳ | "正在识别..." | 加载动画 |
| 完成 | ✅ | `{结果前20字}...` | 绿色调背景 |

### 3.3 动画

| 动画 | 时长 | 效果 |
|------|------|------|
| 淡入 | 200ms | opacity 0 → config |
| 淡出 | 200ms | opacity config → 0 |
| 录音红点 | 500ms | 闪烁 |

---

## 4. 交互流程

### 4.1 首次启动

```
1. 检测 config.json 是否存在
   ├─ 存在: 加载配置，填充 UI
   └─ 不存在: 使用默认值
2. 获取 Ollama 模型列表
   ├─ 成功: 填充下拉框
   └─ 失败: 显示"未检测到 Ollama"
3. 扫描 LLM/ 目录获取角色列表
4. 显示主窗口
```

### 4.2 添加快捷键

```
1. 用户点击 [+ 添加快捷键]
2. 弹出捕获对话框: "请按下要绑定的快捷键..."
3. 用户按下按键
4. 系统识别按键类型 (keyboard/mouse)
5. 在表格末尾添加新行
6. 用户可继续编辑其他列
```

### 4.3 保存配置

```
1. 用户点击 [💾 保存配置]
2. 验证所有配置项
   ├─ 验证失败: 高亮错误字段，显示提示
   └─ 验证成功: 继续
3. 写入 config.json
4. 显示成功 toast: "配置已保存"
```

### 4.4 启动服务

```
1. 用户点击 [🚀 启动服务]
2. 自动保存配置
3. 启动 start_server.py (后台)
4. 等待服务就绪 (检测端口)
5. 启动 start_client.py (后台)
6. 按钮变为 [⏹ 停止服务]
7. 最小化配置窗口到托盘 (可选)
```

---

## 5. 错误处理 UI

### 5.1 验证错误

```
┌─ ⚠️ 配置验证失败 ────────────────────────┐
│                                           │
│  • 快捷键 "F1" 重复定义                   │
│  • API Key 不能为空（云端模式）           │
│                                           │
│                          [确定]           │
└───────────────────────────────────────────┘
```

### 5.2 运行时错误

```
┌─ ❌ 服务启动失败 ─────────────────────────┐
│                                           │
│  无法连接到端口 6016                       │
│  请检查是否有其他程序占用                  │
│                                           │
│            [查看日志]    [关闭]           │
└───────────────────────────────────────────┘
```
