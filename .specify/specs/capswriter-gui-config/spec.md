# Feature Specification: CapsWriter-Offline GUI 配置工具

## 概述

为 CapsWriter-Offline 提供一套图形化配置界面，让用户无需编辑代码即可配置 ASR 模型、快捷键绑定、LLM 角色设置，并在语音识别过程中显示实时状态反馈。

---

## 用户故事

### P1: 图形化配置替代代码编辑

作为 **CapsWriter-Offline 用户**，我希望 **通过图形界面配置软件参数**，以便 **无需理解 Python 代码即可完成个性化设置**。

**验收标准**:
- [ ] 用户可以通过 GUI 选择 ASR 模型（Fun-ASR-Nano / SenseVoice / Paraformer）
- [ ] 用户可以勾选/取消 Vulkan 加速和 FP32 模式
- [ ] 配置保存后，软件下次启动自动应用新配置
- [ ] 配置文件格式与现有 `config.py` 兼容

### P2: 快捷键自定义与角色绑定

作为 **高级用户**，我希望 **自定义多个快捷键并绑定不同的 LLM 角色**，以便 **一键触发翻译、润色、总结等不同功能**。

**验收标准**:
- [ ] 用户可以添加新快捷键（键盘/鼠标）
- [ ] 用户可以删除已有快捷键
- [ ] 用户可以修改快捷键绑定（点击输入框后按新键）
- [ ] 用户可以选择快捷键模式（长按/单击）
- [ ] 用户可以为每个快捷键绑定一个 LLM 角色（翻译、大助理等）或选择"无"
- [ ] 快捷键配置支持至少 8 个并发定义

### P3: LLM 服务灵活配置

作为 **用户**，我希望 **在本地 Ollama 和云端 API 之间灵活切换**，以便 **根据网络环境和使用场景选择最佳方案**。

**验收标准**:
- [ ] 用户可以选择 LLM 来源：本地 Ollama 或云端 API
- [ ] 本地模式：显示已安装的 Ollama 模型列表供选择
- [ ] 云端模式：可选择 Provider（DeepSeek/OpenAI/Moonshot/智谱等）
- [ ] 云端模式：可输入并安全保存 API Key（显示为掩码）
- [ ] 云端模式：可自定义模型名称
- [ ] 支持配置停止输出键（中断 LLM 流式输出）

### P4: 实时状态可视化反馈

作为 **用户**，我希望 **在录音和识别过程中看到可视化状态提示**，以便 **清晰了解当前操作状态，避免误操作**。

**验收标准**:
- [ ] 长按快捷键时，屏幕显示悬浮状态窗口
- [ ] 状态窗口显示当前阶段：录音中 / 识别中 / 完成
- [ ] 录音阶段显示录音时长
- [ ] 用户可以配置状态窗口的位置（屏幕中央/角落）
- [ ] 用户可以配置状态窗口的透明度
- [ ] 状态窗口不阻碍正常操作（始终置顶但可穿透点击）

---

## 功能需求

### 配置界面 (edit_config_gui)

- **FR1**: 提供主配置窗口，包含 ASR 模型、快捷键、LLM、状态提示四个配置区域
- **FR2**: ASR 模型区域提供单选列表，显示模型名称和简短特点说明
- **FR3**: GPU 设置提供两个复选框：Vulkan 加速、强制 FP32
- **FR4**: 快捷键区域提供可编辑表格，支持增删改操作
- **FR5**: 快捷键输入支持"按键捕获"模式（点击输入框后按键自动识别）
- **FR6**: LLM 区域提供来源切换（本地/云端）、模型选择、API 配置
- **FR7**: 状态提示区域提供开关、位置选择、透明度滑块
- **FR8**: 保存按钮将配置写入配置文件
- **FR9**: 启动按钮可直接启动 CapsWriter 服务端和客户端

### 状态悬浮窗 (status_overlay)

- **FR10**: 悬浮窗为半透明圆角矩形，始终置顶
- **FR11**: 显示状态图标（🎙️ 录音 / ⏳ 识别 / ✅ 完成）
- **FR12**: 显示录音时长（秒）
- **FR13**: 完成后显示识别结果预览（前 20 字符）
- **FR14**: 悬浮窗在操作完成后自动淡出消失（可配置延迟）

### 系统集成

- **FR15**: 快捷键绑定角色功能需扩展现有 `Shortcut` 数据类
- **FR16**: 配置工具需能读取现有 `config.py` 并解析当前设置
- **FR17**: 配置工具需能将用户设置写回 `config.py`（或独立配置文件）
- **FR18**: 本地 Ollama 模型列表通过调用 `ollama list` 命令获取

---

## 用户场景

### 场景 1：首次配置

1. 用户双击 `edit_config_gui.py` 启动配置工具
2. 工具显示当前默认配置（Fun-ASR-Nano、CapsLock 快捷键）
3. 用户选择 SenseVoice 模型（追求速度）
4. 用户添加 F1 快捷键，绑定"翻译"角色
5. 用户选择本地 Ollama，选择 `gemma3:4b` 模型
6. 用户勾选"显示悬浮状态窗口"
7. 用户点击"保存配置"
8. 用户点击"启动服务"→ 服务端和客户端启动

### 场景 2：快捷键自定义

1. 用户打开配置工具
2. 用户点击"添加快捷键"
3. 用户按下 `F2` 键，系统捕获并显示
4. 用户选择"长按模式"
5. 用户选择角色"大助理"
6. 用户保存配置

### 场景 3：使用状态反馈

1. 用户长按 CapsLock
2. 屏幕中央出现悬浮窗显示"🎙️ 正在录音... 0.0s"
3. 录音时长实时更新
4. 用户松开 CapsLock
5. 悬浮窗显示"⏳ 正在识别..."
6. 识别完成，悬浮窗显示"✅ 你好世界..." 
7. 1.5 秒后悬浮窗淡出消失

---

## 成功标准

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 配置完成时间 | 首次配置 < 3 分钟 | 用户测试 |
| 状态窗口响应延迟 | < 100ms | 按键到窗口出现 |
| 配置保存成功率 | 100% | 保存后重启加载验证 |
| 快捷键识别准确率 | 100% | 按键捕获测试 |
| 用户满意度 | 无需查阅文档即可完成配置 | 无技术背景用户测试 |

---

## 假设条件

- **A1**: 用户使用 Windows 操作系统（当前 CapsWriter-Offline 仅支持 Windows）
- **A2**: 若使用本地 Ollama，用户已安装 Ollama 并下载至少一个模型
- **A3**: 若使用云端 API，用户拥有有效的 API Key
- **A4**: Python 运行环境已配置完成（用户已能运行现有脚本）
- **A5**: 悬浮状态窗口使用 Windows 原生 GUI 框架（如 tkinter 或 PyQt）
- **A6**: 配置文件格式：优先保持与现有 `config.py` 兼容，必要时使用 JSON/YAML 辅助文件

---

## 依赖关系

- **D1**: 依赖现有 `config.py` 结构和 `Shortcut` 数据类
- **D2**: 依赖现有 LLM 角色加载机制（`LLM/` 目录下的 `.py` 文件）
- **D3**: 依赖 Ollama CLI（`ollama list`）获取本地模型列表
- **D4**: 依赖 Windows GUI 框架（tkinter 已随 Python 自带）

---

## 范围边界 (Out of Scope)

- ❌ 不涉及 ASR 模型的下载和安装（用户需自行下载）
- ❌ 不涉及 Ollama 的安装和模型下载
- ❌ 不涉及 macOS/Linux 支持
- ❌ 不涉及 Web 界面或远程配置
- ❌ 不涉及多语言界面（仅中文）
